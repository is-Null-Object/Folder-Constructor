<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FolderFlow</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a0a;color:#e4e4e7;min-height:100vh;display:flex}
.sidebar{width:420px;min-width:200px;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.main{flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.sidebar-header{padding:16px 20px;border-bottom:1px solid #27272a}
.sidebar-header h1{font-size:17px;display:flex;align-items:center;gap:8px;margin-bottom:2px}
.sidebar-header p{font-size:11px;color:#71717a}
.sidebar-body{flex:1;overflow-y:auto;padding:0}

/* Drag & Drop Styles */
.section { border-bottom:1px solid #27272a; padding:14px 20px; transition: background 0.15s, border-top 0.1s; position: relative; }
.section.collapsed-section { padding:10px 20px; cursor:default; }
.section.drag-over { border-top: 2px solid #3b82f6; background: #18181b; } 
.section.dragging { opacity: 0.5; background: #18181b; }
.drag-handle { cursor: grab; color: #52525b; font-size: 14px; padding: 4px 8px 4px 0; display: flex; align-items: center; justify-content: center; transition: color 0.15s; }
.drag-handle:hover { color: #a1a1aa; }
.drag-handle:active { cursor: grabbing; color: #e4e4e7; }

.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.section-header.collapsed-header{margin-bottom:0}
.section-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;display:flex;align-items:center;gap:6px;cursor:pointer;flex:1}
.section-hint{font-size:11px;color:#52525b;margin-bottom:8px;line-height:1.4}
.collapsed-hint{font-size:10px;color:#3f3f46;font-style:italic}
.header-right{display:flex;align-items:center;gap:6px}
.tag-list{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}
.tag{display:flex;align-items:center;gap:3px;padding:3px 8px;border-radius:6px;font-size:11px;cursor:default}
.tag-remove{background:none;border:none;color:inherit;cursor:pointer;font-size:13px;opacity:0.5;padding:0 0 0 2px;line-height:1}
.tag-remove:hover{opacity:1}
.input-row{display:flex;gap:5px}
.input-row input{flex:1;background:#18181b;border:1px solid #3f3f46;border-radius:7px;padding:6px 10px;font-size:11px;color:#e4e4e7;outline:none}
.input-row input:focus{border-color:#52525b}
.input-row input::placeholder{color:#52525b}
.btn-add{background:#27272a;border:1px solid #3f3f46;border-radius:7px;padding:6px 10px;color:#a1a1aa;cursor:pointer;font-size:11px;white-space:nowrap;transition:all 0.15s}
.btn-add:hover{background:#3f3f46;color:#e4e4e7}
.btn-clear-tier{background:none;border:1px solid #3f3f46;border-radius:5px;padding:2px 8px;color:#71717a;cursor:pointer;font-size:10px;transition:all 0.15s}
.btn-clear-tier:hover{border-color:#71717a;color:#a1a1aa}
.btn-remove-tier{background:none;border:1px solid #7f1d1d;border-radius:5px;padding:2px 8px;color:#f87171;cursor:pointer;font-size:10px;transition:all 0.15s}
.btn-remove-tier:hover{border-color:#991b1b;background:rgba(127,29,29,0.15)}

.toggle-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:6px 10px;background:#18181b;border-radius:7px;border:1px solid #27272a}
.toggle-label{font-size:11px;cursor:pointer;padding:3px 8px;border-radius:5px;transition:all 0.15s;color:#52525b;font-weight:500}
.toggle-label:hover{color:#a1a1aa}
.group{margin-bottom:8px;background:#111113;border:1px solid #27272a;border-radius:8px;overflow:hidden}
.group-header{display:flex;align-items:center;gap:6px;padding:8px 12px;border-bottom:1px solid #1e1e21;cursor:pointer;transition:background 0.15s}
.group-header:hover{background:#18181b}
.group-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.group-name{font-size:12px;font-weight:600;flex:1}
.group-count{font-size:10px;color:#52525b}
.group-chevron{color:#52525b;font-size:11px;transition:transform 0.2s}
.group-chevron.open{transform:rotate(90deg)}
.group-body{padding:8px 12px}
.group-body.collapsed{display:none}
.insert-tier-zone{display:flex;justify-content:center;padding:2px 20px;border-bottom:1px solid #27272a;cursor:pointer;transition:padding 0.15s}
.insert-tier-zone:hover{padding:6px 20px}
.insert-tier-zone:hover .insert-tier-btn{opacity:1}
.insert-tier-btn{font-size:10px;color:#52525b;background:none;border:1px dashed transparent;border-radius:6px;padding:2px 12px;cursor:pointer;opacity:0;transition:opacity 0.15s,border-color 0.15s}
.insert-tier-zone:hover .insert-tier-btn{border-color:#3f3f46}
.insert-tier-btn:hover{color:#a1a1aa;border-color:#52525b}
.output-section{padding:14px 20px;border-top:1px solid #27272a}
.preview-header{padding:14px 20px;border-bottom:1px solid #27272a;display:flex;align-items:center;justify-content:space-between}
.preview-header h2{font-size:14px;font-weight:600}
.preview-controls{display:flex;align-items:center;gap:8px}
.badge{font-size:11px;background:#27272a;color:#a1a1aa;padding:2px 10px;border-radius:10px}
.view-tabs{display:flex;gap:2px;background:#18181b;border-radius:7px;padding:2px;border:1px solid #27272a}
.view-tab{font-size:11px;padding:4px 10px;border-radius:5px;cursor:pointer;color:#52525b;border:none;background:none;font-weight:500;transition:all 0.15s}
.view-tab:hover{color:#a1a1aa}
.view-tab.active{color:#e4e4e7;background:#27272a}
.preview-body{flex:1;overflow:auto;padding:16px 20px;font-family:'SF Mono','Consolas',monospace;font-size:12px}
.preview-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#3f3f46;gap:8px;font-family:-apple-system,sans-serif}
.preview-empty span{font-size:32px}
.preview-empty p{font-size:13px}
.tree-row{display:flex;align-items:center;gap:5px;padding:1.5px 0;white-space:nowrap;cursor:pointer;border-radius:4px}
.tree-row:hover{background:rgba(255,255,255,0.03)}
.tree-toggle{width:14px;flex-shrink:0;text-align:center;font-size:9px;color:#52525b;transition:transform 0.15s}
.tree-toggle.open{transform:rotate(90deg)}
.tree-toggle.leaf{visibility:hidden}
.tc{color:#3f3f46;width:18px;flex-shrink:0;text-align:center;font-size:11px}
.fi{width:13px;height:13px;flex-shrink:0}
.column-view{flex:1;display:flex;overflow-x:auto;overflow-y:hidden}
.column{min-width:160px;width:220px;border-right:1px solid #27272a;display:flex;flex-direction:column;height:100%;position:relative;flex-shrink:0}
.column-header{padding:8px 12px;border-bottom:1px solid #27272a;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;flex-shrink:0}
.column-body{flex:1;overflow-y:auto;padding:4px 0}
.column-item{padding:6px 12px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.1s;border-radius:0}
.column-item:hover{background:rgba(255,255,255,0.05)}
.column-item.selected{background:rgba(255,255,255,0.08)}
.column-item-arrow{margin-left:auto;color:#3f3f46;font-size:10px}
.col-resize{position:absolute;right:-3px;top:0;bottom:0;width:6px;cursor:col-resize;z-index:10}
.col-resize:hover,.col-resize.resizing{background:rgba(255,255,255,0.12)}
.panel-resize{width:5px;background:#27272a;cursor:col-resize;flex-shrink:0;transition:background 0.1s}
.panel-resize:hover,.panel-resize.resizing{background:rgba(255,255,255,0.15)}
.sunburst-container{flex:1;overflow:auto;position:relative;padding:24px}
.htree-wrap{display:inline-flex;min-width:max-content}
.htree-node{display:inline-flex;align-items:center}
.htree-card{padding:6px 12px;border-radius:7px;font-size:12px;white-space:nowrap;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:background 0.15s;border:1px solid #27272a;background:#18181b}
.htree-card:hover{background:#27272a}
.htree-connector{display:inline-flex;align-items:center}
.htree-hline{width:20px;height:1px;background:#3f3f46;flex-shrink:0}
.htree-children{display:flex;flex-direction:column;position:relative}
.htree-branch{display:flex;align-items:center}
.htree-branch-line{width:20px;flex-shrink:0;position:relative}
.htree-branch-line::after{content:'';position:absolute;top:50%;left:0;width:100%;height:1px;background:#3f3f46}
.htree-vline{position:absolute;left:0;width:1px;background:#3f3f46}

/* Move tier flash animation */
@keyframes tierFlash {
  0% { background: rgba(251,191,36,0.15); }
  100% { background: transparent; }
}
.tier-just-moved { animation: tierFlash 0.6s ease-out; }

@media(max-width:900px){body{flex-direction:column}.sidebar{width:100%;min-width:0;height:auto;max-height:55vh;border-right:none;border-bottom:1px solid #27272a}.main{height:45vh}}
</style>
</head>
<body>
<div class="sidebar">
  <div class="sidebar-header">
    <h1>üìÅ FolderFlow <button id="helpBtn" onclick="toggleHelp(event)" style="background:#18181b;border:1px solid #27272a;border-radius:50%;width:22px;height:22px;font-size:11px;cursor:pointer;color:#52525b;font-weight:700;display:inline-flex;align-items:center;justify-content:center;transition:all 0.15s;padding:0;line-height:1" onmouseover="this.style.color='#a1a1aa';this.style.borderColor='#3f3f46'" onmouseout="this.style.color='#52525b';this.style.borderColor='#27272a'">?</button></h1>
    <div id="helpPopup" style="display:none;position:fixed;top:50px;left:20px;z-index:9999;background:#18181b;border:1px solid #3f3f46;border-radius:10px;padding:14px 16px;font-size:11px;line-height:1.6;color:#a1a1aa;width:340px;max-height:400px;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.6)">
      <div style="font-weight:700;color:#e4e4e7;margin-bottom:6px;font-size:12px">Quick Guide</div>
      <div style="color:#71717a;margin-bottom:8px">Type folder names or paste a column from Excel / Google Sheets / CSV. Comma-separated entries work too.</div>
      <div style="font-weight:600;color:#d4d4d8;margin-top:8px">Subfolders</div>
      <div style="color:#71717a">Click <span style="color:#a1a1aa">+ Add Subfolders</span> to nest folders inside parent folders. By default, items are <span style="color:#a1a1aa">Global</span> (replicated in every parent). Switch to <span style="color:#a1a1aa">Child of Parent</span> for unique subfolders per parent.</div>
      <div style="font-weight:600;color:#d4d4d8;margin-top:8px">Reorder &amp; Edit</div>
      <div style="color:#71717a">Drag the <span style="color:#a1a1aa">‚†ø</span> grip handle to reorder levels. Double-click any tag to rename it.</div>
      <div style="font-weight:600;color:#d4d4d8;margin-top:8px">Preview</div>
      <div style="color:#71717a">Switch between <span style="color:#a1a1aa">Tree</span>, <span style="color:#a1a1aa">Columns</span>, and <span style="color:#a1a1aa">Flowchart</span> views. Click nodes to expand/collapse.</div>
      <div style="font-weight:600;color:#d4d4d8;margin-top:8px">Export</div>
      <div style="color:#71717a">Click <span style="color:#a1a1aa">Download Folders</span> to select a destination on your computer. The tool will create the folders instantly.</div>
      <div style="height:1px;background:#27272a;margin:10px 0"></div>
      <div style="color:#3f3f46;font-size:10px;font-style:italic">Refreshing the page resets everything. No save functionality yet.</div>
    </div></h1>
    <p>Build, visualize, and download your folder structure.</p>
  </div>
  <div class="sidebar-body" id="sidebarBody"></div>
  <div class="output-section">
    <button id="directWriteBtn" style="width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;background:#2563eb;color:white;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;" onclick="writeToDisk()" disabled>üìÇ Download Folders</button>
  </div>
</div>
<div class="panel-resize" id="panelResize"></div>
<div class="main">
  <div class="preview-header">
    <h2>Preview</h2>
    <div class="preview-controls">
      <span class="badge" id="folderBadge">0 folders</span>
      <div class="view-tabs">
        <button class="view-tab active" onclick="setView('tree')">Tree</button>
        <button class="view-tab" onclick="setView('columns')">Columns</button>
        <button class="view-tab" onclick="setView('htree')">Flowchart</button>
      </div>
    </div>
  </div>
  <div id="previewBody" class="preview-body">
    <div class="preview-empty"><span>üìÇ</span><p>Add folders to see your structure</p></div>
  </div>
  <div id="columnView" class="column-view" style="display:none"></div>
  <div id="sunburstView" class="sunburst-container" style="display:none">
    <div class="htree-wrap" id="htreeWrap"></div>
  </div>
</div>

<script>
const COLORS=[
  {name:"amber",dot:"#fbbf24",text:"#fbbf24",tagBg:"rgba(251,191,36,0.12)",tagBorder:"rgba(251,191,36,0.2)",toggleBg:"rgba(251,191,36,0.12)",previewIcon:"#fbbf24",previewText:"#fafafa",previewWeight:"600"},
  {name:"blue",dot:"#60a5fa",text:"#60a5fa",tagBg:"rgba(96,165,250,0.12)",tagBorder:"rgba(96,165,250,0.2)",toggleBg:"rgba(96,165,250,0.12)",previewIcon:"#60a5fa",previewText:"#d4d4d8",previewWeight:"normal"},
  {name:"green",dot:"#34d399",text:"#34d399",tagBg:"rgba(52,211,153,0.12)",tagBorder:"rgba(52,211,153,0.2)",toggleBg:"rgba(52,211,153,0.12)",previewIcon:"#34d399",previewText:"#a1a1aa",previewWeight:"normal"},
  {name:"purple",dot:"#c084fc",text:"#c084fc",tagBg:"rgba(192,132,252,0.12)",tagBorder:"rgba(192,132,252,0.2)",toggleBg:"rgba(192,132,252,0.12)",previewIcon:"#c084fc",previewText:"#b4b4bd",previewWeight:"normal"},
  {name:"rose",dot:"#fb7185",text:"#fb7185",tagBg:"rgba(251,113,133,0.12)",tagBorder:"rgba(251,113,133,0.2)",toggleBg:"rgba(251,113,133,0.12)",previewIcon:"#fb7185",previewText:"#c4c4cc",previewWeight:"normal"},
  {name:"cyan",dot:"#22d3ee",text:"#22d3ee",tagBg:"rgba(34,211,238,0.12)",tagBorder:"rgba(34,211,238,0.2)",toggleBg:"rgba(34,211,238,0.12)",previewIcon:"#22d3ee",previewText:"#b8b8c0",previewWeight:"normal"},
];
const MAX_TIERS=6;

let tiers=[{id:"tier0",label:"Root Directory",items:[],mode:"global",perParent:{},open:true}];
let expanded={};
let tierIdCounter=2;
let currentView="tree";
let treeCollapsed={};
let columnSelection=[];
let colWidths=[];
let justMovedTierId=null;
let draggedTierIdx = null;
let undoStack=[];
const MAX_UNDO=50;
function saveHistory(){undoStack.push(JSON.stringify(tiers));if(undoStack.length>MAX_UNDO)undoStack.shift()}
function undo(){if(!undoStack.length)return;tiers=JSON.parse(undoStack.pop());editingTag=null;renderAll()}

function toggleHelp(e){e&&e.stopPropagation();const p=document.getElementById('helpPopup');p.style.display=p.style.display==='none'?'block':'none'}
document.addEventListener('click',function(e){const p=document.getElementById('helpPopup');if(p&&p.style.display!=='none'&&!p.contains(e.target)&&e.target.id!=='helpBtn'){p.style.display='none'}});

function san(n){return n.replace(/[<>:"/\\|?*]/g,"_").trim()}
function pi(raw){return raw.split(/[\n\r\t,]+/).map(s=>s.trim()).filter(Boolean).map(san).filter(Boolean)}
function parseGrid(raw){
  return raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n')
    .filter(row=>row.trim())
    .map(row=>row.split('\t').map(s=>san(s.trim())));
}
function handleMultiColumnPaste(grid,startTierIdx){
  const numCols=grid.reduce((max,row)=>Math.max(max,row.length),0);
  const colsToProcess=Math.min(numCols,MAX_TIERS-startTierIdx);
  while(tiers.length<startTierIdx+colsToProcess){
    if(tiers.length>=MAX_TIERS)break;
    tiers.push({id:"tier"+tierIdCounter++,label:"Subfolders (Level "+(tiers.length+1)+")",items:[],mode:"global",perParent:{},open:true});
  }
  const tier0=tiers[startTierIdx];
  grid.forEach(row=>{const v=row[0]||'';if(v&&!tier0.items.includes(v))tier0.items.push(v);});
  for(let col=1;col<colsToProcess;col++){
    const tierIdx=startTierIdx+col;
    if(tierIdx>=tiers.length)break;
    const t=tiers[tierIdx];
    t.mode='per';
    grid.forEach(row=>{
      const parentVal=row[col-1]||'';
      const childVal=row[col]||'';
      if(!parentVal||!childVal)return;
      if(!t.perParent[parentVal])t.perParent[parentVal]=[];
      if(!t.perParent[parentVal].includes(childVal))t.perParent[parentVal].push(childVal);
    });
  }
}

document.addEventListener('paste', function(e) {
  const activeEl = document.activeElement;
  if (activeEl && activeEl.tagName === 'INPUT' && activeEl.id && (activeEl.id.startsWith('inp-') || activeEl.id.startsWith('pp-'))) {
    const clipboardData = e.clipboardData || window.clipboardData;
    const pastedText = clipboardData.getData('text');
    if (pastedText.includes('\n') || pastedText.includes('\r') || pastedText.includes('\t')) {
      e.preventDefault();
      const inputId = activeEl.id;
      if (inputId.startsWith('inp-')) {
        const tierIdx = tiers.findIndex(t => 'inp-' + t.id === inputId);
        if (tierIdx !== -1) {
          const grid = parseGrid(pastedText);
          const isMultiCol = grid.some(row => row.filter(c => c !== '').length > 1);
          saveHistory();
          if (isMultiCol) {
            handleMultiColumnPaste(grid, tierIdx);
          } else {
            const items = grid.map(row => row[0] || '').filter(Boolean);
            items.forEach(v => { if (!tiers[tierIdx].items.includes(v)) tiers[tierIdx].items.push(v); });
          }
          renderAll();
        }
      } else if (inputId.startsWith('pp-')) {
        const items = pi(pastedText);
        for (let tierIdx = 0; tierIdx < tiers.length; tierIdx++) {
          const t = tiers[tierIdx];
          const prefix = 'pp-' + t.id + '-';
          if (inputId.startsWith(prefix)) {
            const parentName = Object.keys(t.perParent).find(p => 'pp-' + t.id + '-' + cssId(p) === inputId);
            if (parentName !== undefined) {
              saveHistory();
              if (!t.perParent[parentName]) t.perParent[parentName] = [];
              items.forEach(v => { if (!t.perParent[parentName].includes(v)) t.perParent[parentName].push(v); });
              renderAll();
            }
            break;
          }
        }
      }
    }
  }
});

function esc(s){return s.replace(/'/g,"\\'").replace(/\\/g,"\\\\")}
function cssId(s){return CSS.escape(s)}
function tierColor(idx){return COLORS[idx%COLORS.length]}
function natSort(a){return[...a].sort((x,y)=>x.localeCompare(y,undefined,{numeric:true,sensitivity:'base'}))}

let editingTag=null;
function startEditTag(tierIdx,itemIdx){editingTag={tierIdx,itemIdx,type:'item'};renderAll()}
function startEditPerParentItem(tierIdx,parentName,itemIdx){editingTag={tierIdx,itemIdx,type:'perParentItem',parentName};renderAll()}
function startEditParentName(tierIdx,parentName){editingTag={tierIdx,type:'parentName',parentName,itemIdx:-1};renderAll()}
function commitEdit(inputEl){
  if(!editingTag)return;
  const newVal=san(inputEl.value.trim());
  saveHistory();
  const t=tiers[editingTag.tierIdx];
  if(editingTag.type==='item'){
    const oldVal=t.items[editingTag.itemIdx];
    if(newVal&&newVal!==oldVal){
      if(!t.items.includes(newVal)){
        const old=t.items[editingTag.itemIdx];
        tiers.forEach((child,ci)=>{if(ci>editingTag.tierIdx&&child.perParent[old]){child.perParent[newVal]=child.perParent[old];delete child.perParent[old]}});
        Object.keys(expanded).forEach(k=>{if(k.includes(":"+old)){expanded[k.replace(":"+old,":"+newVal)]=expanded[k];delete expanded[k]}});
        t.items[editingTag.itemIdx]=newVal;
      }
    } else if(!newVal){
      const old=t.items[editingTag.itemIdx];
      tiers.forEach((child,ci)=>{if(ci>editingTag.tierIdx)delete child.perParent[old]});
      t.items.splice(editingTag.itemIdx,1);
    }
  } else if(editingTag.type==='perParentItem'){
    const arr=t.perParent[editingTag.parentName];
    if(arr){
      const oldVal=arr[editingTag.itemIdx];
      if(newVal&&newVal!==oldVal){
        if(!arr.includes(newVal)){
          tiers.forEach((child,ci)=>{if(ci>editingTag.tierIdx&&child.perParent[oldVal]){child.perParent[newVal]=child.perParent[oldVal];delete child.perParent[oldVal]}});
          Object.keys(expanded).forEach(k=>{if(k.includes(":"+oldVal)){expanded[k.replace(":"+oldVal,":"+newVal)]=expanded[k];delete expanded[k]}});
          arr[editingTag.itemIdx]=newVal;
        }
      } else if(!newVal){
        const old=arr[editingTag.itemIdx];
        tiers.forEach((child,ci)=>{if(ci>editingTag.tierIdx)delete child.perParent[old]});
        arr.splice(editingTag.itemIdx,1);
      }
    }
  } else if(editingTag.type==='parentName'){
    const aboveTier=tiers[editingTag.tierIdx-1];
    const oldName=editingTag.parentName;
    if(newVal&&newVal!==oldName){
      const idxInItems=aboveTier.items.indexOf(oldName);
      if(idxInItems!==-1&&!aboveTier.items.includes(newVal)){aboveTier.items[idxInItems]=newVal}
      else{Object.values(aboveTier.perParent).forEach(arr=>{const pi2=arr.indexOf(oldName);if(pi2!==-1&&!arr.includes(newVal))arr[pi2]=newVal})}
      if(t.perParent[oldName]){t.perParent[newVal]=t.perParent[oldName];delete t.perParent[oldName]}
      tiers.forEach((child,ci)=>{if(ci>editingTag.tierIdx&&child.perParent[oldName]){child.perParent[newVal]=child.perParent[oldName];delete child.perParent[oldName]}});
      Object.keys(expanded).forEach(k=>{if(k.includes(":"+oldName)){expanded[k.replace(":"+oldName,":"+newVal)]=expanded[k];delete expanded[k]}});
    }
  }
  editingTag=null;renderAll();
}
function cancelEdit(){editingTag=null;renderAll()}
function editKeyHandler(e){if(e.key==='Enter'){e.preventDefault();commitEdit(e.target)}else if(e.key==='Escape'){cancelEdit()}}
function isEditing(tierIdx,itemIdx,type,parentName){
  if(!editingTag)return false;
  if(editingTag.tierIdx!==tierIdx||editingTag.type!==type)return false;
  if(type==='item')return editingTag.itemIdx===itemIdx;
  if(type==='perParentItem')return editingTag.parentName===parentName&&editingTag.itemIdx===itemIdx;
  if(type==='parentName')return editingTag.parentName===parentName;
  return false;
}

function addItem(tierIdx){const t=tiers[tierIdx];const inp=document.getElementById("inp-"+t.id);if(!inp)return;const vals=pi(inp.value).filter(v=>!t.items.includes(v));if(!vals.length)return;saveHistory();vals.forEach(v=>t.items.push(v));inp.value="";renderAll()}
function removeItem(tierIdx,itemIdx){saveHistory();const old=tiers[tierIdx].items[itemIdx];tiers.forEach((child,ci)=>{if(ci>tierIdx)delete child.perParent[old]});tiers[tierIdx].items.splice(itemIdx,1);renderAll()}
function clearTier(tierIdx){saveHistory();tiers[tierIdx].items=[];tiers[tierIdx].perParent={};renderAll()}
function setMode(tierIdx,mode){saveHistory();tiers[tierIdx].mode=mode;renderAll()}
function toggleTierOpen(tierIdx){tiers[tierIdx].open=!tiers[tierIdx].open;renderAll()}
function addPerParentItem(tierIdx,parentName){const t=tiers[tierIdx];const inp=document.getElementById("pp-"+t.id+"-"+cssId(parentName));if(!inp)return;const vals=pi(inp.value).filter(v=>!(t.perParent[parentName]||[]).includes(v));if(!vals.length)return;saveHistory();if(!t.perParent[parentName])t.perParent[parentName]=[];vals.forEach(v=>t.perParent[parentName].push(v));inp.value="";renderAll()}
function removePerParentItem(tierIdx,parentName,itemIdx){saveHistory();tiers[tierIdx].perParent[parentName].splice(itemIdx,1);renderAll()}
function togGroup(key){expanded[key]=!expanded[key];renderAll()}
function addTier(){if(tiers.length>=MAX_TIERS)return;saveHistory();tiers.push({id:"tier"+tierIdCounter++,label:"Subfolders (Level "+(tiers.length+1)+")",items:[],mode:"global",perParent:{},open:true});renderAll()}
function removeTier(tierIdx){if(tiers.length<=1)return;saveHistory();tiers.splice(tierIdx,1);tiers.forEach((t,i)=>{if(i===0)t.label="Root Directory";else t.label="Subfolders (Level "+(i+1)+")"});renderAll()}

function handleDragStart(e, idx) { draggedTierIdx = idx; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', idx); e.target.closest('.section').classList.add('dragging'); }
function handleDragOver(e, idx) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const section = document.getElementById('section-' + idx); if (section && idx !== draggedTierIdx) { section.classList.add('drag-over'); } }
function handleDragLeave(e, idx) { const section = document.getElementById('section-' + idx); if (section) section.classList.remove('drag-over'); }
function handleDrop(e, toIdx) { e.preventDefault(); const fromIdx = draggedTierIdx; document.querySelectorAll('.section').forEach(el => { el.classList.remove('dragging'); el.classList.remove('drag-over'); }); draggedTierIdx = null; if (fromIdx === null || fromIdx === toIdx) return; reorderTiers(fromIdx, toIdx); }
function reorderTiers(fromIdx, toIdx){ saveHistory(); const item = tiers.splice(fromIdx, 1)[0]; tiers.splice(toIdx, 0, item); tiers.forEach((t, i) => { if (i === 0 && t.mode === 'per_parent') { const allItems = new Set(t.items); Object.values(t.perParent).forEach(arr => arr.forEach(v => allItems.add(v))); t.items = [...allItems]; t.mode = 'global'; t.perParent = {}; } else if (i > 0 && t.mode === 'per_parent') { const parentNames = new Set(); collectAllNames(i - 1, parentNames); const currentKeys = Object.keys(t.perParent); const allValid = currentKeys.every(k => parentNames.has(k)); if (!allValid) { const allItems = new Set(t.items); Object.values(t.perParent).forEach(arr => arr.forEach(v => allItems.add(v))); t.items = [...allItems]; t.mode = 'global'; t.perParent = {}; } } }); tiers.forEach((t, i) => { if (i === 0) t.label = "Root Directory"; else t.label = "Subfolders (Level " + (i + 1) + ")"; }); justMovedTierId = item.id; treeCollapsed = {}; columnSelection = []; renderAll(); setTimeout(() => { justMovedTierId = null; }, 700); }

function getItemsForTier(tierIdx,parentName){const t=tiers[tierIdx];if(tierIdx===0)return t.items;if(t.mode==="global")return t.items;return t.perParent[parentName]||[]}
function getUniqueParentNames(tierIdx){if(tierIdx===0)return[];const names=new Set();collectAllNames(tierIdx-1,names);return[...names]}
function collectAllNames(tierIdx,nameSet){const t=tiers[tierIdx];if(tierIdx===0){t.items.forEach(n=>nameSet.add(n));return}if(t.mode==="global"){t.items.forEach(n=>nameSet.add(n))}else{Object.values(t.perParent).forEach(arr=>arr.forEach(n=>nameSet.add(n)))}}
function tierHasContent(tierIdx){const t=tiers[tierIdx];return t.items.length>0||Object.values(t.perParent).some(a=>a.length)}
function tierItemCount(tierIdx){const t=tiers[tierIdx];if(t.mode==="global"||tierIdx===0)return t.items.length;return Object.values(t.perParent).reduce((s,a)=>s+a.length,0)}

function setView(v){
  currentView=v;
  document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.view-tab').forEach(t=>{if(t.textContent.toLowerCase()===v||(v==='columns'&&t.textContent==='Columns')||(v==='tree'&&t.textContent==='Tree'))t.classList.add('active')});
  document.getElementById('previewBody').style.display=v==='tree'?'':'none';
  document.getElementById('columnView').style.display=v==='columns'?'flex':'none';
  document.getElementById('sunburstView').style.display=v==='htree'?'':'none';
  renderPreview();
}

function buildDataTree(){
  const root={name:"root",children:[],tier:-1};
  function build(parentNode,tierIdx,parentName){
    if(tierIdx>=tiers.length)return;
    const items=natSort(getItemsForTier(tierIdx,parentName));
    if(!items.length){build(parentNode,tierIdx+1,parentName);return}
    items.forEach(item=>{
      const node={name:item,children:[],tier:tierIdx};
      parentNode.children.push(node);
      build(node,tierIdx+1,item);
    });
  }
  if(tiers[0].items.length){
    natSort(tiers[0].items).forEach(item=>{
      const node={name:item,children:[],tier:0};
      root.children.push(node);
      if(tiers.length>1)build(node,1,item);
    });
  } else if(tiers.length>1){
    build(root,1,null);
  }
  return root;
}

function countNodes(node){let c=0;if(node.tier>=0)c=1;node.children.forEach(ch=>{c+=countNodes(ch)});return c}

function insertTierAt(idx){
  if(tiers.length>=MAX_TIERS)return;
  saveHistory();
  const newTier={id:"tier"+tierIdCounter++,label:"",items:[],mode:"global",perParent:{},open:true};
  tiers.splice(idx,0,newTier);
  tiers.forEach((t,i)=>{if(i===0)t.label="Root Directory";else t.label="Subfolders (Level "+(i+1)+")"});
  renderAll();
}

function renderSidebar(){
  const sb=document.getElementById("sidebarBody");
  let html="";
  if(tiers.length<MAX_TIERS){
    html+=`<div class="insert-tier-zone" onclick="insertTierAt(0)"><button class="insert-tier-btn">+ Insert</button></div>`;
  }
  tiers.forEach((tier,idx)=>{
    const col=tierColor(idx);const isOpen=tier.open;const hasContent=tierHasContent(idx);const count=tierItemCount(idx);const canRemove=tiers.length>1;
    const isFlash = tier.id === justMovedTierId;
    const flashClass = isFlash ? ' tier-just-moved' : '';
    const dragAttrs = `draggable="true" ondragstart="handleDragStart(event, ${idx})" ondragover="handleDragOver(event, ${idx})" ondragleave="handleDragLeave(event, ${idx})" ondrop="handleDrop(event, ${idx})"`;
    const sectionStart = `<div class="section${flashClass}" id="section-${idx}" ${dragAttrs}>`;
    const dragHandle = `<div class="drag-handle" title="Drag to reorder">‚†ø</div>`;

    if(!isOpen){
      html+=`${sectionStart}<div class="section-header collapsed-header" onclick="toggleTierOpen(${idx})">${dragHandle}<span class="section-label" style="color:${col.text}">‚óè ${tier.label}</span><div class="header-right">${hasContent?`<span class="tag" style="background:${col.tagBg};color:${col.text};border:1px solid ${col.tagBorder}">${count} items</span>`:`<span class="collapsed-hint">click to expand</span>`}</div></div></div>`;
      return;
    }
    html+=`${sectionStart}<div class="section-header"><div style="display:flex;align-items:center;flex:1">${dragHandle}<span class="section-label" style="color:${col.text}" onclick="toggleTierOpen(${idx})">‚óè ${tier.label}</span></div><div class="header-right">${hasContent?`<button class="btn-clear-tier" onclick="clearTier(${idx})">Clear</button>`:""} ${canRemove?`<button class="btn-remove-tier" onclick="removeTier(${idx})">Remove</button>`:""}</div></div>`;
    if(idx===0){
      html+=renderTagsHTML(tier.items,col,"removeItem",idx);
      html+=`<div class="input-row"><input type="text" id="inp-${tier.id}" placeholder="Paste or type folders..." onkeydown="if(event.key==='Enter'){addItem(${idx});return;}"><button class="btn-add" onclick="addItem(${idx})">+ Add</button></div>`;
    } else {
      html+=`<div class="toggle-row"><span class="toggle-label" style="${tier.mode==="global"?`color:${col.text};background:${col.toggleBg}`:""}" onclick="setMode(${idx},'global')">Global</span><span class="toggle-label" style="${tier.mode==="per"?`color:${col.text};background:${col.toggleBg}`:""}" onclick="setMode(${idx},'per')">Child of Parent</span></div>`;
      if(tier.mode==="global"){
        html+=renderTagsHTML(tier.items,col,"removeItem",idx);
        html+=`<div class="input-row"><input type="text" id="inp-${tier.id}" placeholder="Paste or type folders..." onkeydown="if(event.key==='Enter'){addItem(${idx});return;}"><button class="btn-add" onclick="addItem(${idx})">+ Add</button></div>`;
      } else {
        const parents=natSort(getUniqueParentNames(idx));
        if(!parents.length){html+=`<div style="font-size:11px;color:#3f3f46;padding:6px 0">Add items above first</div>`}
        else{
          const parentCol=tierColor(idx-1);
          parents.forEach(pName=>{
            if(!tier.perParent[pName])tier.perParent[pName]=[];
            const subs=tier.perParent[pName];const gKey=tier.id+":"+pName;const isExp=expanded[gKey]!==false;expanded[gKey]=isExp;const e=esc(pName);
            const tags=subs.map((s,i)=>{
              if(isEditing(idx,i,'perParentItem',pName)){return`<span class="tag" style="background:${col.tagBg};color:${col.text};border:1px solid ${col.tagBorder};padding:0"><input type="text" class="tag-edit" id="edit-tag" value="${s}" onkeydown="editKeyHandler(event)" onblur="commitEdit(this)" style="background:transparent;border:none;color:${col.text};font-size:11px;padding:3px 8px;width:${Math.max(40,s.length*7+16)}px;outline:none;font-family:inherit"></span>`}
              return`<span class="tag" style="background:${col.tagBg};color:${col.text};border:1px solid ${col.tagBorder}" ondblclick="startEditPerParentItem(${idx},'${e}',${i})">${s}<button class="tag-remove" onclick="removePerParentItem(${idx},'${e}',${i})">&times;</button></span>`;
            }).join("");
            let pNameHTML=isEditing(idx,-1,'parentName',pName)?`<input type="text" id="edit-tag" value="${pName}" onkeydown="editKeyHandler(event)" onblur="commitEdit(this)" style="background:transparent;border:none;color:${parentCol.text};font-size:12px;font-weight:600;width:${Math.max(60,pName.length*8+16)}px;outline:none;font-family:inherit" onclick="event.stopPropagation()">`:`<span class="group-name" style="color:${parentCol.text};cursor:text" ondblclick="event.stopPropagation();startEditParentName(${idx},'${e}')">${pName}</span>`;
            html+=`<div class="group"><div class="group-header"><span class="group-dot" style="background:${parentCol.dot};cursor:pointer" onclick="togGroup('${esc(gKey)}')"></span>${pNameHTML}<span class="group-count">${subs.length}</span><span class="group-chevron ${isExp?"open":""}" style="cursor:pointer" onclick="togGroup('${esc(gKey)}')">‚ñ∂</span></div><div class="group-body ${isExp?"":"collapsed"}"><div class="tag-list">${tags}</div><div class="input-row"><input type="text" id="pp-${tier.id}-${cssId(pName)}" placeholder="Paste or type folders..." onkeydown="if(event.key==='Enter'){addPerParentItem(${idx},'${e}');return;}"><button class="btn-add" onclick="addPerParentItem(${idx},'${e}')">+ Add</button></div></div></div>`;
          });
        }
      }
    }
    html+=`</div>`;
    if(idx<tiers.length-1&&tiers.length<MAX_TIERS){
      html+=`<div class="insert-tier-zone" onclick="insertTierAt(${idx+1})"><button class="insert-tier-btn">+ Insert</button></div>`;
    }
  });
  html+=`<div style="border-bottom:1px solid #27272a;padding:10px 20px"><button onclick="addTier()" ${tiers.length>=MAX_TIERS?"disabled":""} style="width:100%;padding:9px;border:1px dashed #3f3f46;border-radius:10px;font-size:12px;font-weight:500;cursor:pointer;background:transparent;color:#71717a;display:flex;align-items:center;justify-content:center;gap:6px">+ Add Subfolders${tiers.length>=MAX_TIERS?" (max "+MAX_TIERS+")":""}</button></div>`;
  sb.innerHTML=html;
}

function renderTagsHTML(items,col,removeFn,tierIdx){
  if(!items.length)return"";
  var sorted=items.map(function(v,i){return{v:v,i:i}}).sort(function(a,b){return a.v.localeCompare(b.v,undefined,{numeric:true,sensitivity:'base'})});
  return`<div class="tag-list">${sorted.map(function(obj){
    var v=obj.v,i=obj.i;
    if(isEditing(tierIdx,i,'item')){return`<span class="tag" style="background:${col.tagBg};color:${col.text};border:1px solid ${col.tagBorder};padding:0"><input type="text" class="tag-edit" id="edit-tag" value="${v}" onkeydown="editKeyHandler(event)" onblur="commitEdit(this)" style="background:transparent;border:none;color:${col.text};font-size:11px;padding:3px 8px;width:${Math.max(40,v.length*7+16)}px;outline:none;font-family:inherit"></span>`}
    return`<span class="tag" style="background:${col.tagBg};color:${col.text};border:1px solid ${col.tagBorder}" ondblclick="startEditTag(${tierIdx},${i})">${v}<button class="tag-remove" onclick="${removeFn}(${tierIdx},${i})">&times;</button></span>`;
  }).join("")}</div>`
}

function fSVG(color){return`<svg class="fi" style="color:${color}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5z"/></svg>`}
function toggleTreeNode(path){treeCollapsed[path]=!treeCollapsed[path];renderPreview()}

function renderTreeView(){
  const box=document.getElementById("previewBody");
  const tree=buildDataTree();
  let html="";
  function renderNode(node,connectors,isLast,parentPath){
    if(node.tier<0){node.children.forEach((ch,i)=>renderNode(ch,[],i===node.children.length-1,""));return}
    const col=tierColor(node.tier);const path=parentPath?parentPath+"/"+node.name:node.name;const isCollapsed=treeCollapsed[path]===true;
    let h='<div class="tree-row" onclick="toggleTreeNode(\''+esc(path)+'\')">';
    connectors.forEach(c=>{h+=`<span class="tc">${c}</span>`});
    h+=node.children.length?`<span class="tree-toggle ${isCollapsed?"":"open"}">‚ñ∂</span>`:`<span class="tree-toggle leaf"></span>`;
    h+=fSVG(col.previewIcon)+` <span style="color:${col.previewText};font-weight:${col.previewWeight}">${node.name}</span></div>`;
    html+=h;
    if(node.children.length&&!isCollapsed){
      node.children.forEach((ch,i)=>{const childIsLast=i===node.children.length-1;const newConn=[...connectors,childIsLast?"&nbsp;":"‚îÇ"];renderNode(ch,newConn,childIsLast,path);});
    }
  }
  tree.children.forEach((ch,i)=>{renderNode(ch,[],i===tree.children.length-1,"");html+=`<div style="height:4px"></div>`;});
  box.innerHTML=html||`<div class="preview-empty"><span>üìÇ</span><p>Add folders to see your structure</p></div>`;
}

function renderColumnView(){
  const container=document.getElementById("columnView");
  const tree=buildDataTree();
  let html="";
  let currentChildren=tree.children;
  let columns=[{items:currentChildren,tierIdx:currentChildren.length?currentChildren[0].tier:0,selectedName:columnSelection[0]||null}];
  for(let depth=0;depth<columnSelection.length;depth++){
    const found=currentChildren.find(c=>c.name===columnSelection[depth]);
    if(found&&found.children.length){currentChildren=found.children;columns.push({items:currentChildren,tierIdx:currentChildren[0].tier,selectedName:columnSelection[depth+1]||null});}
    else break;
  }
  columns.forEach((col,colIdx)=>{
    const tierCol=tierColor(col.tierIdx);
    const w=colWidths[colIdx]||220;
    html+=`<div class="column" style="width:${w}px"><div class="column-header" style="color:${tierCol.text}">${tiers[col.tierIdx]?tiers[col.tierIdx].label:"Tier "+(col.tierIdx+1)}</div><div class="column-body">`;
    natSort(col.items.map(c=>c.name)).forEach(name=>{
      const node=col.items.find(c=>c.name===name);
      html+=`<div class="column-item ${col.selectedName===name?"selected":""}" onclick="selectColumn(${colIdx},'${esc(name)}')" style="color:${tierCol.previewText}">${fSVG(tierCol.previewIcon)} ${name}${node&&node.children.length?`<span class="column-item-arrow">‚ñ∂</span>`:""}</div>`;
    });
    html+=`</div><div class="col-resize" data-col="${colIdx}"></div></div>`;
  });
  container.innerHTML=html;
  container.querySelectorAll('.col-resize').forEach(h=>h.addEventListener('mousedown',startColResize));
}

function selectColumn(colIdx,name){columnSelection=columnSelection.slice(0,colIdx);columnSelection[colIdx]=name;renderPreview()}

function renderHTreeView(){
  const container=document.getElementById("htreeWrap");
  const tree=buildDataTree();
  if(!tree.children.length){container.innerHTML=`<div class="preview-empty"><span>üìÇ</span><p>Add folders to see your structure</p></div>`;return}

  // Measure pass
  const tierWidths={};
  const measureContainer=document.createElement('div');
  measureContainer.style.cssText="position:absolute;visibility:hidden;top:-9999px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:12px;font-weight:600;";
  document.body.appendChild(measureContainer);

  function collectNodes(node){
    const el=document.createElement('div');
    el.style.cssText="display:inline-block;padding:6px 12px;border:1px solid;white-space:nowrap;";
    el.innerHTML=`<span style="width:13px;display:inline-block"></span> ${node.name} <span style="font-size:9px">‚ñ∂</span>`;
    measureContainer.appendChild(el);
    node._measureEl=el;
    if(node.children) node.children.forEach(collectNodes);
  }
  collectNodes(tree);

  function measureNodes(node){
    if(node.tier!==-1){
        const w=node._measureEl.offsetWidth+10; 
        tierWidths[node.tier]=Math.max(tierWidths[node.tier]||0, w);
    }
    node.children.forEach(measureNodes);
  }
  measureNodes(tree);
  document.body.removeChild(measureContainer);

  function assignPaths(node,pp){node._path=pp?pp+"/"+node.name:node.name;node.children.forEach(ch=>assignPaths(ch,node._path))}
  tree.children.forEach(ch=>assignPaths(ch,""));
  
  function renderNode(node){
    const col=tierColor(node.tier);const path=node._path;const isCollapsed=treeCollapsed[path]===true;
    const w = tierWidths[node.tier] + 4; 
    
    let h=`<div class="htree-node"><div class="htree-card" style="width:${w}px;color:${col.previewText};border-color:${col.dot}40;justify-content:flex-start" onclick="toggleTreeNode('${esc(path)}')">${fSVG(col.previewIcon)} <span style="font-weight:${col.previewWeight};margin-left:5px;flex:1;overflow:hidden;text-overflow:ellipsis">${node.name}</span>`;
    if(node.children.length){
        h+=`<span style="font-size:9px;color:#52525b;margin-left:4px">${isCollapsed?"‚ñ∂":"‚ñº"}</span></div><div class="htree-connector"><div class="htree-hline"></div><div class="htree-children">`;
        node.children.forEach((ch)=>{if(!isCollapsed)h+=`<div class="htree-branch"><div class="htree-branch-line"></div>${renderNode(ch)}</div>`});
        h+=`</div></div>`
    }else{
        h+=`</div>`
    }
    h+=`</div>`;
    return h;
  }
  let html=`<div style="display:flex;flex-direction:column;gap:16px">`;tree.children.forEach(ch=>{html+=renderNode(ch)});html+=`</div>`;container.innerHTML=html;
  requestAnimationFrame(()=>{document.querySelectorAll('.htree-children').forEach(el=>{el.querySelectorAll(':scope > .htree-vline').forEach(l=>l.remove());const branches=el.querySelectorAll(':scope > .htree-branch');if(branches.length<2)return;const first=branches[0],last=branches[branches.length-1],parentRect=el.getBoundingClientRect(),top=first.getBoundingClientRect().top+first.getBoundingClientRect().height/2-parentRect.top,bottom=last.getBoundingClientRect().top+last.getBoundingClientRect().height/2-parentRect.top,line=document.createElement('div');line.className='htree-vline';line.style.top=top+'px';line.style.height=(bottom-top)+'px';el.appendChild(line);});});
}

function renderPreview(){
  if(currentView==="tree")renderTreeView();
  else if(currentView==="columns")renderColumnView();
  else if(currentView==="htree")renderHTreeView();
  const total=countNodes(buildDataTree());
  document.getElementById("folderBadge").textContent=total+" folders";
  const has=tiers.some((_,i)=>tierHasContent(i));
  document.getElementById("directWriteBtn").disabled=!has;
}

function renderAll(){
  const activeEl=document.activeElement,activeId=activeEl&&activeEl.tagName==="INPUT"?activeEl.id:null,activeVal=activeId?activeEl.value:"",activeSel=activeId?[activeEl.selectionStart,activeEl.selectionEnd]:null;
  renderSidebar();renderPreview();
  if(activeId){const el=document.getElementById(activeId);if(el){el.value=activeVal;el.focus();if(activeSel)el.setSelectionRange(activeSel[0],activeSel[1])}}
  if(editingTag){const ed=document.getElementById("edit-tag");if(ed){ed.focus();ed.select()}}
}

function buildPaths(){
  const paths=[];
  function walk(tierIdx,parentName,pathParts){
    if(tierIdx>=tiers.length){if(pathParts.length)paths.push(pathParts.join("/"));return}
    const items=natSort(getItemsForTier(tierIdx,parentName));
    if(!items.length){walk(tierIdx+1,parentName,pathParts);return}
    items.forEach(item=>{const np=[...pathParts,item];if(tierIdx+1>=tiers.length)paths.push(np.join("/"));else walk(tierIdx+1,item,np);});
  }
  if(tiers[0].items.length){natSort(tiers[0].items).forEach(item=>{if(tiers.length>1)walk(1,item,[item]);else paths.push(item)})}
  else if(tiers.length>1){walk(1,null,[])}
  return paths;
}

async function writeToDisk() {
  const paths = buildPaths(); if (!paths.length) return;
  try {
    const rootHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
    for (const path of paths) {
      const parts = path.split('/'); let currentHandle = rootHandle;
      for (const part of parts) { currentHandle = await currentHandle.getDirectoryHandle(part, { create: true }); }
    }
    const total = countNodes(buildDataTree());
    alert(`‚úÖ ${total} folders created successfully!`);
  } catch (err) {
    if (err.name === 'AbortError') return;
    alert("Error writing to disk. This feature requires a secure connection (HTTPS) and a modern browser like Chrome or Edge.");
  }
}

document.addEventListener('keydown',function(e){
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){
    const el=document.activeElement;
    // Only let the browser handle native undo inside the inline tag-rename input
    if(el&&el.id==='edit-tag')return;
    e.preventDefault();
    undo();
  }
});

function startColResize(e){
  e.preventDefault();
  const handle=this;
  const colIdx=+handle.dataset.col;
  const col=handle.parentElement;
  const startX=e.clientX;
  const startW=col.offsetWidth;
  handle.classList.add('resizing');
  function onMove(e){
    const newW=Math.max(160,startW+(e.clientX-startX));
    col.style.width=newW+'px';
    colWidths[colIdx]=newW;
  }
  function onUp(){
    handle.classList.remove('resizing');
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onUp);
  }
  document.addEventListener('mousemove',onMove);
  document.addEventListener('mouseup',onUp);
}

document.getElementById('panelResize').addEventListener('mousedown',function(e){
  e.preventDefault();
  const handle=this;
  const sidebar=document.querySelector('.sidebar');
  const startX=e.clientX;
  const startW=sidebar.offsetWidth;
  handle.classList.add('resizing');
  function onMove(e){
    const newW=Math.max(200,Math.min(700,startW+(e.clientX-startX)));
    sidebar.style.width=newW+'px';
  }
  function onUp(){
    handle.classList.remove('resizing');
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onUp);
  }
  document.addEventListener('mousemove',onMove);
  document.addEventListener('mouseup',onUp);
});

renderAll();
</script>
</body>
</html>
